<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>🎙️ Nagrywacz z obrazem</title>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
<style>
body {
  background: #fce4ec;
  font-family: "SF Pro Display", sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 40px;
}
h1 {
  color: #d81b60;
  margin-bottom: 20px;
}
button {
  background: #ec407a;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 14px;
  font-size: 16px;
  cursor: pointer;
  margin: 10px;
  transition: 0.2s;
}
button:hover {
  background: #d81b60;
}
#segments {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 20px;
}
.segment {
  background: white;
  border-radius: 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  padding: 12px;
  width: 160px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.segment input {
  border: none;
  border-bottom: 1px solid #ec407a;
  text-align: center;
  width: 100%;
  margin-bottom: 8px;
}
.segment button {
  padding: 6px 12px;
  font-size: 13px;
}
#preview {
  margin-top: 30px;
}
</style>
</head>
<body>
<h1>🎀 Nagrywacz Audio + Obraz 🎀</h1>
<button id="recordBtn">🎙️ Rozpocznij nagrywanie</button>
<input type="file" id="imageUpload" accept="image/*">
<button id="exportBtn">📦 Eksportuj jako MP4</button>

<div id="segments"></div>
<video id="preview" controls width="480"></video>

<script>
const recordBtn = document.getElementById('recordBtn');
const exportBtn = document.getElementById('exportBtn');
const segmentsDiv = document.getElementById('segments');
const imageUpload = document.getElementById('imageUpload');
const preview = document.getElementById('preview');

let mediaRecorder;
let chunks = [];
let recordings = [];
let recording = false;
let selectedImage = null;

// === NAGRYWANIE ===
recordBtn.onclick = async () => {
  if (!recording) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const url = URL.createObjectURL(blob);
      const name = "Segment " + (recordings.length + 1);
      recordings.push({ blob, name });
      addSegmentUI(name, url);
      chunks = [];
    };
    mediaRecorder.start();
    recordBtn.textContent = "⏹️ Zatrzymaj nagrywanie";
    recording = true;
  } else {
    mediaRecorder.stop();
    recordBtn.textContent = "🎙️ Rozpocznij nagrywanie";
    recording = false;
  }
};

function addSegmentUI(name, url) {
  const div = document.createElement('div');
  div.className = 'segment';
  div.innerHTML = `
    <input type="text" value="${name}">
    <audio controls src="${url}"></audio>
    <button>🗑️ Usuń</button>
  `;
  const input = div.querySelector('input');
  const del = div.querySelector('button');
  input.addEventListener('change', () => {
    const seg = recordings.find(r => r.name === name);
    if (seg) seg.name = input.value;
  });
  del.onclick = () => {
    recordings = recordings.filter(r => r.name !== input.value);
    div.remove();
  };
  segmentsDiv.appendChild(div);
}

// === WGRYWANIE OBRAZU ===
imageUpload.onchange = e => {
  selectedImage = e.target.files[0];
};

// === EKSPORT DO MP4 ===
exportBtn.onclick = async () => {
  if (recordings.length === 0) return alert("Brak nagrań!");
  if (!selectedImage) return alert("Wgraj obraz!");

  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: true });
  await ffmpeg.load();

  // połącz wszystkie nagrania
  const audioFiles = [];
  for (let i = 0; i < recordings.length; i++) {
    const data = await recordings[i].blob.arrayBuffer();
    const fname = `a${i}.webm`;
    ffmpeg.FS('writeFile', fname, new Uint8Array(data));
    audioFiles.push(`file '${fname}'`);
  }

  ffmpeg.FS('writeFile', 'list.txt', new TextEncoder().encode(audioFiles.join('\n')));
  await ffmpeg.run('-f', 'concat', '-safe', '0', '-i', 'list.txt', '-c', 'copy', 'merged.webm');

  const imageData = await fetchFile(selectedImage);
  ffmpeg.FS('writeFile', 'image.png', imageData);

  await ffmpeg.run('-loop', '1', '-i', 'image.png', '-i', 'merged.webm', '-c:v', 'libx264', '-c:a', 'aac',
                   '-shortest', '-pix_fmt', 'yuv420p', 'output.mp4');

  const data = ffmpeg.FS('readFile', 'output.mp4');
  const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
  preview.src = url;

  const a = document.createElement('a');
  a.href = url;
  a.download = 'nagranie.mp4';
  a.textContent = '⬇️ Pobierz MP4';
  document.body.appendChild(a);
};
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üéÄ Glosoweczki Karolinki üéÄ</title>
<script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js"></script>
<style>
body {
  background: linear-gradient(135deg,#ffd9ec,#ffb8d2);
  font-family: "SF Pro Display","Helvetica Neue",sans-serif;
  display:flex;flex-direction:column;align-items:center;min-height:100vh;
  margin:0;padding-top:40px;color:#333;
}
h1{color:#ff5caa;text-shadow:0 2px 6px rgba(255,140,180,.5);}
button{
  border:none;border-radius:12px;font-weight:600;
  box-shadow:0 4px 10px rgba(255,150,200,.4);transition:.2s;cursor:pointer;
  background:#ff9ac9;color:white;padding:10px 20px;margin:0 8px;
}
button:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(255,150,200,.5);}
#segments{width:80%;max-width:700px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:15px;margin-top:20px;}
.segment{
  background:rgba(255,255,255,.7);backdrop-filter:blur(8px);
  border-radius:20px;box-shadow:0 4px 14px rgba(255,160,200,.4);
  display:flex;flex-direction:column;align-items:center;padding:14px;
  cursor:grab;animation:fadeIn .4s ease;
}
.segment input{border:none;border-radius:10px;padding:6px;width:90%;margin-bottom:8px;text-align:center;}
.segment audio{width:100%;margin-bottom:8px;}
.segment button{background:#ff8fbc;padding:6px 12px;font-size:13px;}
.segment button:hover{background:#ff75ae;}
@keyframes fadeIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:scale(1);}}
</style>
</head>
<body>
<h1>üéÄ Glosoweczki Karolinki üéÄ</h1>
<div>
  <button id="recordBtn">üéôÔ∏è Nagraj</button>
  <button id="exportBtn">üíæ Eksportuj MP3</button>
</div>
<div id="segments"></div>

<script>
let isRecording=false, mediaRecorder,chunks=[],recordings=[];

// Toggle nagrywania
document.getElementById("recordBtn").onclick = async () => {
  if(!isRecording){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    chunks=[];
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks,{type:"audio/webm"});
      recordings.push({blob,name:"Segment "+(recordings.length+1)});
      renderSegments();
    };
    mediaRecorder.start();
    isRecording = true;
    recordBtn.textContent="‚èπÔ∏è Zatrzymaj";
  } else {
    mediaRecorder.stop();
    isRecording = false;
    recordBtn.textContent="üéôÔ∏è Nagraj";
  }
};

// renderowanie segment√≥w
const container = document.getElementById("segments");
function renderSegments(){
  container.innerHTML="";
  recordings.forEach((r,i)=>{
    const div=document.createElement("div");
    div.className="segment";div.draggable=true;
    const inp=document.createElement("input");
    inp.value=r.name;
    inp.onchange=()=>r.name=inp.value.trim()||"Segment "+(i+1);
    const audio=document.createElement("audio");
    audio.controls=true;
    audio.src=URL.createObjectURL(r.blob);
    const del=document.createElement("button");
    del.textContent="‚ùå Usu≈Ñ";
    del.onclick=()=>{recordings.splice(i,1);renderSegments();};
    div.append(inp,audio,del);
    container.append(div);
  });
  enableDrag();
}
function enableDrag(){
  let dragEl;
  document.querySelectorAll(".segment").forEach(seg=>{
    seg.addEventListener("dragstart",()=>dragEl=seg);
    seg.addEventListener("dragover",e=>e.preventDefault());
    seg.addEventListener("drop",e=>{
      e.preventDefault();
      const nodes=[...seg.parentNode.children];
      const from=nodes.indexOf(dragEl),to=nodes.indexOf(seg);
      recordings.splice(to,0,recordings.splice(from,1)[0]);
      renderSegments();
    });
  });
}

// Eksport MP3 z po≈ÇƒÖczonych segment√≥w
document.getElementById("exportBtn").onclick = async ()=>{
  if(!recordings.length) return alert("Brak segment√≥w!");
  const ctx = new AudioContext();
  let fullBuffer;

  // Dekodowanie i ≈ÇƒÖczenie
  for(const rec of recordings){
    const arr = await rec.blob.arrayBuffer();
    const buf = await ctx.decodeAudioData(arr);
    if(!fullBuffer){
      fullBuffer = ctx.createBuffer(buf.numberOfChannels, buf.length, buf.sampleRate);
      for(let c=0;c<buf.numberOfChannels;c++){
        fullBuffer.getChannelData(c).set(buf.getChannelData(c),0);
      }
    }else{
      const tmp = ctx.createBuffer(buf.numberOfChannels, fullBuffer.length+buf.length, buf.sampleRate);
      for(let c=0;c<buf.numberOfChannels;c++){
        tmp.getChannelData(c).set(fullBuffer.getChannelData(c),0);
        tmp.getChannelData(c).set(buf.getChannelData(c), fullBuffer.length);
      }
      fullBuffer=tmp;
    }
  }

  // konwersja do MP3 przez lamejs
  const left = fullBuffer.getChannelData(0);
  const right = fullBuffer.numberOfChannels>1 ? fullBuffer.getChannelData(1) : left;
  const mp3encoder = new lamejs.Mp3Encoder(2, fullBuffer.sampleRate, 128);
  const blockSize = 1152;
  let mp3Data = [];
  for (let i = 0; i < left.length; i += blockSize) {
    const leftChunk = left.subarray(i, i + blockSize);
    const rightChunk = right.subarray(i, i + blockSize);
    const mp3buf = mp3encoder.encodeBuffer(convertFloat32ToInt16(leftChunk), convertFloat32ToInt16(rightChunk));
    if (mp3buf.length > 0) mp3Data.push(mp3buf);
  }
  const mp3buf = mp3encoder.flush();
  if(mp3buf.length>0) mp3Data.push(mp3buf);
  const blob = new Blob(mp3Data,{type:"audio/mpeg"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="nagranie.mp3";
  a.click();
  alert("‚úÖ Plik MP3 zosta≈Ç wyeksportowany!");
};

function convertFloat32ToInt16(buffer){
  let l = buffer.length;
  const buf = new Int16Array(l);
  while (l--) buf[l] = Math.max(-1, Math.min(1, buffer[l])) * 0x7fff;
  return buf;
}
</script>
</body>
</html>
